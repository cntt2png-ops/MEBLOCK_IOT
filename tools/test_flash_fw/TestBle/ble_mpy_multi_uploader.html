<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Web Bluetooth • Upload nhiều file .py (MicroPython NUS)</title>
  <style>
    :root{--panel:#121826;--muted:#9aa4b2;--text:#e5e7eb;--brand:#4f46e5;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;--border:#1f2937;--radius:16px;--shadow:0 10px 35px rgba(0,0,0,.25);}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(120deg,#0b0e14,#10131b);color:var(--text);font:14px/1.55 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:18px 22px;position:sticky;top:0;background:rgba(11,14,20,.7);backdrop-filter:blur(6px);border-bottom:1px solid var(--border);z-index:10}
    header h1{font-size:16px;margin:0;font-weight:600;letter-spacing:.2px}
    .badge{font-size:11px;color:#9ca3af;border:1px solid var(--border);padding:2px 8px;border-radius:999px}
    .wrap{max-width:900px;margin:24px auto;padding:0 16px 60px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .sec{padding:16px}
    .sec h2{margin:0 0 12px;font-size:13px;letter-spacing:.4px;text-transform:uppercase;color:var(--muted)}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input[type=text]{width:100%;background:#0f1422;color:var(--text);border:1px solid #263041;border-radius:12px;padding:10px 12px;outline:none}
    input[type=file]{width:100%}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button{appearance:none;border:1px solid #2a3550;background:#192038;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-size:13px}
    button.primary{background:var(--brand);border-color:transparent}
    button.good{background:#0b2d24;border-color:#0b2d24;color:#a7f3d0}
    button.warn{background:#2b2410;border-color:#2b2410;color:#fde68a}
    button.danger{background:#2b1618;border-color:#2b1618;color:#fecaca}
    button:disabled{opacity:.45;cursor:not-allowed}
    .tiny{font-size:12px;color:var(--muted)}
    .status{display:flex;align-items:center;gap:8px}
    .dot{width:10px;height:10px;border-radius:999px;background:#6b7280}
    .dot.ok{background:var(--ok)} .dot.bad{background:var(--err)}
    .banner{background:#1f2937;color:#e5e7eb;border-left:4px solid var(--warn);padding:10px 12px;border-radius:8px;margin:0 0 12px}
    .log{background:#0a0f1a;border-top:1px solid var(--border);max-height:420px;overflow:auto;padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap;font-size:12px}
    progress{width:100%;height:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>Web Bluetooth • Upload nhiều file .py (MicroPython NUS)</h1>
      <span class="badge">folder • multi-py • /lib</span>
    </div>
    <div class="status">
      <span id="connDot" class="dot"></span>
      <span id="connLabel">Disconnected</span>
    </div>
  </header>

  <div class="wrap">
    <div id="insecureBanner" class="banner" style="display:none">
      Web Bluetooth bắt buộc chạy trên <b>HTTPS</b> hoặc <b>localhost</b>.
    </div>

    <div class="card">
      <div class="sec">
        <h2>1) Kết nối BLE (NUS)</h2>
        <div class="grid">
          <div>
            <label>Name prefix</label>
            <input id="namePrefix" type="text" value="MEBLOCK-" />
          </div>
          <div>
            <label>BLE write chunk (bytes)</label>
            <input id="bleChunk" type="text" value="100" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btnConnect" class="primary">Connect</button>
          <button id="btnDisconnect">Disconnect</button>
          <button id="btnStop" class="warn">Stop (CTRL-C)</button>
          <button id="btnReset" class="danger">machine.reset()</button>
        </div>
        <div class="tiny">Chrome/Edge. Thiết bị cần bridge NUS ↔ MicroPython REPL.</div>

        <hr style="border:0;border-top:1px solid var(--border);margin:14px 0">

        <h2>2) Chọn thư mục chứa thư viện (.py)</h2>
        <label>Chọn thư mục (tool sẽ nạp toàn bộ file <code>.py</code> trong thư mục này)</label>
        <input id="pickFolder" type="file" webkitdirectory directory multiple />

        <div class="grid">
          <div>
            <label>Base path trên thiết bị</label>
            <input id="basePath" type="text" value="/lib" />
            <div class="tiny">Để root thì để trống hoặc nhập <code>/</code>.</div>
          </div>
          <div>
            <label>Chunk size file (bytes)</label>
            <input id="fileChunk" type="text" value="512" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <label class="tiny" style="margin:0">
            <input type="checkbox" id="preserveFolders" checked style="vertical-align:middle;margin-right:6px" />
            Giữ subfolder (theo webkitRelativePath)
          </label>

          <label class="tiny" style="margin:0">
            <input type="checkbox" id="flattenToRoot" style="vertical-align:middle;margin-right:6px" />
            Flatten (chỉ basename)
          </label>

          <label class="tiny" style="margin:0">
            <input type="checkbox" id="autoReset" checked style="vertical-align:middle;margin-right:6px" />
            Auto reset sau khi nạp xong
          </label>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btnFlash" class="good">Flash folder (.py) → device</button>
          <button id="btnAbort" class="danger">Abort</button>
          <button id="btnClear" style="margin-left:auto">Clear log</button>
        </div>

        <label style="margin-top:14px">Overall progress</label>
        <progress id="prog" max="100" value="0"></progress>
        <div class="tiny" id="progText">0 / 0 bytes</div>

        <div class="tiny" id="summary" style="margin-top:8px">Chưa chọn thư mục.</div>
      </div>

      <div class="log" id="log"></div>
    </div>
  </div>

  <script type="module">
    import { BleMicroPythonNUS } from './ble_mpy_multi_uploader.js';

    const $ = (sel) => document.querySelector(sel);
    const logEl = $('#log');

    function log(t){
      const d=document.createElement('div');
      d.textContent=t;
      logEl.appendChild(d);
      logEl.scrollTop=logEl.scrollHeight;
    }

    function setConn(connected, name){
      $('#connDot').classList.toggle('ok', connected);
      $('#connDot').classList.toggle('bad', !connected);
      $('#connLabel').textContent = connected ? `Connected • ${name||''}` : 'Disconnected';
      $('#btnConnect').disabled = connected;
      $('#btnDisconnect').disabled = !connected;
      $('#btnStop').disabled = !connected;
      $('#btnReset').disabled = !connected;
      $('#btnFlash').disabled = !connected;
      $('#btnAbort').disabled = !connected;
    }

    function fmtBytes(n){
      if(!Number.isFinite(n)) return '';
      if(n < 1024) return `${n} B`;
      if(n < 1024*1024) return `${(n/1024).toFixed(1)} KB`;
      return `${(n/1024/1024).toFixed(2)} MB`;
    }

    if(!window.isSecureContext && location.hostname !== 'localhost'){
      $('#insecureBanner').style.display = '';
    }

    let ble=null;
    let picked=[];

    function rebuildSummary(){
      const py=picked.filter(f=>f.name.toLowerCase().endsWith('.py'));
      const total=py.reduce((s,f)=>s+(f.size||0),0);
      $('#summary').textContent = py.length ? `Đã chọn: ${py.length} file .py • Tổng: ${fmtBytes(total)}` : 'Thư mục không có file .py.';
      $('#prog').value = 0;
      $('#progText').textContent = `0 / ${fmtBytes(total)}`;
      return { py, total };
    }

    $('#pickFolder').addEventListener('change', (e)=>{
      picked = Array.from(e.target.files||[]);
      rebuildSummary();
      log(`[FOLDER] selected ${picked.length} item(s)\n`);
    });

    $('#btnClear').addEventListener('click', ()=>{ logEl.innerHTML=''; });

    $('#btnConnect').addEventListener('click', async ()=>{
      try{
        const prefix = ($('#namePrefix').value || 'MEBLOCK-').trim();
        const bleChunk = Math.max(20, parseInt($('#bleChunk').value,10) || 100);
        ble = new BleMicroPythonNUS({
          onLog:(t)=>log(t),
          onStatus:(ok,name)=>setConn(ok,name),
          paceMs:3,
          bleWriteChunk: bleChunk,
        });
        await ble.connect({ namePrefix: prefix });
      }catch(err){
        log(`[CONNECT ERROR] ${err?.message||err}\n`);
        setConn(false,'');
      }
    });

    $('#btnDisconnect').addEventListener('click', async ()=>{
      try{ await ble?.disconnect(); }catch(err){ log(`[DISCONNECT ERR] ${err?.message||err}\n`); }
    });

    $('#btnStop').addEventListener('click', async ()=>{
      try{ await ble?.stop(); }catch(err){ log(`[STOP ERR] ${err?.message||err}\n`); }
    });

    $('#btnReset').addEventListener('click', async ()=>{
      try{ await ble?.reset(); }catch(err){ log(`[RESET ERR] ${err?.message||err}\n`); }
    });

    $('#btnAbort').addEventListener('click', ()=>{
      ble?.abortFlash();
      log('[ABORT] requested.\n');
    });

    $('#btnFlash').addEventListener('click', async ()=>{
      if(!ble || !ble.connected){ log('[WARN] chưa connect BLE.\n'); return; }
      const { py, total } = rebuildSummary();
      if(!py.length){ log('[WARN] không có file .py.\n'); return; }

      const basePath = ($('#basePath').value || '').trim();
      const preserveFolders = $('#preserveFolders').checked;
      const flattenToRoot = $('#flattenToRoot').checked;
      const autoReset = $('#autoReset').checked;
      const fileChunkSize = Math.max(128, parseInt($('#fileChunk').value,10) || 512);

      try{
        await ble.flashFiles(py, {
          basePath, preserveFolders, flattenToRoot,
          overwrite:true, autoReset, fileChunkSize,
          onOverallProgress: ({written,total})=>{
            $('#prog').value = total ? (written/total*100) : 0;
            $('#progText').textContent = `${fmtBytes(written)} / ${fmtBytes(total)}`;
          }
        });
      }catch(err){
        log(`\n[FLASH ERROR] ${err?.message||err}\n`);
      }
    });

    setConn(false,'');
  </script>
</body>
</html>
