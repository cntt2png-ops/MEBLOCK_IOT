<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web Bluetooth • MicroPython NUS Demo</title>
  <style>
    :root {
      --bg:#0b0e14;
      --panel:#121826;
      --muted:#9aa4b2;
      --text:#e5e7eb;
      --brand:#4f46e5;
      --ok:#10b981;
      --warn:#f59e0b;
      --err:#ef4444;
      --border:#1f2937;
      --radius:16px;
      --shadow:0 10px 35px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      background:linear-gradient(120deg,#0b0e14,#10131b);
      color:var(--text);
      font:14px/1.55 system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:18px 22px;
      position:sticky;
      top:0;
      background:rgba(11,14,20,.7);
      backdrop-filter:blur(6px);
      border-bottom:1px solid var(--border);
      z-index:10;
    }
    header h1{
      font-size:16px;
      margin:0;
      font-weight:600;
      letter-spacing:.2px;
    }
    .badge{
      font-size:11px;
      color:#9ca3af;
      border:1px solid var(--border);
      padding:2px 8px;
      border-radius:999px;
    }
    .wrap{
      max-width:1100px;
      margin:24px auto;
      padding:0 16px 60px;
    }
    .grid{
      display:grid;
      grid-template-columns:330px 1fr;
      gap:16px;
    }
    @media (max-width:900px){
      .grid{grid-template-columns:1fr;}
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .sec{padding:16px;}
    .sec h2{
      margin:0 0 12px;
      font-size:13px;
      letter-spacing:.4px;
      text-transform:uppercase;
      color:var(--muted);
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:10px 0 6px;
    }
    input[type=text]{
      width:100%;
      background:#0f1422;
      color:var(--text);
      border:1px solid #263041;
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    input[type=text]:focus{border-color:var(--brand);}
    input[type=file]{width:100%;}
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    button{
      appearance:none;
      border:1px solid #2a3550;
      background:#192038;
      color:var(--text);
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
    }
    button.primary{background:var(--brand);border-color:transparent;}
    button.good{background:#0b2d24;border-color:#0b2d24;color:#a7f3d0;}
    button.warn{background:#2b2410;border-color:#2b2410;color:#fde68a;}
    button.danger{background:#2b1618;border-color:#2b1618;color:#fecaca;}
    button:disabled{opacity:.45;cursor:not-allowed;}
    .tiny{font-size:12px;color:var(--muted);}
    .log{
      background:#0a0f1a;
      border-top:1px solid var(--border);
      max-height:440px;
      overflow:auto;
      padding:12px;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space:pre-wrap;
      font-size:12px;
    }
    .status{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      background:#6b7280;
    }
    .dot.ok{background:var(--ok);}
    .dot.bad{background:var(--err);}
    .banner{
      background:#1f2937;
      color:#e5e7eb;
      border-left:4px solid var(--warn);
      padding:10px 12px;
      border-radius:8px;
      margin:0 0 12px;
      font-size:13px;
    }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <h1>Web Bluetooth • MicroPython NUS Demo</h1>
      <span class="badge">NUS • raw REPL • flash</span>
    </div>
    <div class="status">
      <span id="connDot" class="dot"></span>
      <span id="connLabel">Disconnected</span>
    </div>
  </header>

  <div class="wrap">
    <div id="insecureBanner" class="banner" style="display:none">
      Web Bluetooth bắt buộc chạy trên <b>HTTPS</b> hoặc <b>localhost</b>.
    </div>

    <div class="card">
      <div class="sec grid">
        <div>
          <h2>Thiết bị</h2>
          <p class="tiny">
            Tool mặc định scan các thiết bị có tên bắt đầu bằng <code>MEBLOCK-</code>.
          </p>
          <div class="row" style="margin-top:10px">
            <button id="btnConnect" class="primary">Connect</button>
            <button id="btnDisconnect">Disconnect</button>
          </div>
          <div class="tiny">Chọn đúng thiết bị BLE (NUS). Dùng Chrome/Edge mới.</div>

          <hr style="border:0;border-top:1px solid var(--border);margin:14px 0">

          <h2>Đổi tên BLE (MEBLOCK-...)</h2>
          <label>Suffix mới (phần sau <code>MEBLOCK-</code>)</label>
          <input id="bleSuffix" type="text" placeholder="VD: R1-01" />
          <div class="row" style="margin-top:10px">
            <button id="btnSetBleName" class="good">Set name &amp; reset</button>
            <span class="tiny">Gửi: <code>setting.set_device_suffix(...); machine.reset()</code></span>
          </div>

          <hr style="border:0;border-top:1px solid var(--border);margin:14px 0">

          <h2>Flash (ghi vào flash)</h2>
          <label>Chọn file .py</label>
          <input id="flashFile" type="file" accept=".py" />
          <label>Tên file đích trên thiết bị</label>
          <input id="dstName" type="text" value="main.py" />
          <div class="row" style="margin-top:10px">
            <button id="btnFlash" class="good">Flash to device</button>
            <span class="tiny">Ghi theo chunk base64; không reset.</span>
          </div>
        </div>

        <div>
          <h2>Run (không flash)</h2>
          <label>Chọn file .py để chạy ngay</label>
          <input id="runFile" type="file" accept=".py" />
          <div class="row" style="margin-top:10px">
            <button id="btnRunFile" class="primary">Run file (no flash)</button>
            <button id="btnStop" class="warn">Stop (CTRL-C)</button>
            <button id="btnReset" class="danger">machine.reset()</button>
            <label class="tiny">
              <input type="checkbox" id="autoScroll" checked style="vertical-align:middle;margin-right:6px" />
              Auto-scroll log
            </label>
          </div>
        </div>
      </div>

      <div class="log" id="log"></div>
    </div>
  </div>

  <script type="module">
    import { BleMicroPythonNUS } from './bluetooth_uploader.js';

    const $ = sel => document.querySelector(sel);
    const logEl = $('#log');
    const autoScrollEl = $('#autoScroll');

    function log(txt) {
      const t = document.createElement('div');
      t.textContent = txt;
      logEl.appendChild(t);
      if (autoScrollEl.checked) logEl.scrollTop = logEl.scrollHeight;
    }

    function setConn(connected, name) {
      const dot = $('#connDot');
      dot.classList.toggle('ok', connected);
      dot.classList.toggle('bad', !connected);
      $('#connLabel').textContent = connected
        ? `Connected${name ? ' • ' + name : ''}`
        : 'Disconnected';
      $('#btnConnect').disabled = connected;
      $('#btnDisconnect').disabled = !connected;
      $('#btnRunFile').disabled = !connected;
      $('#btnStop').disabled = !connected;
      $('#btnFlash').disabled = !connected;
      $('#btnReset').disabled = !connected;
      $('#btnSetBleName').disabled = !connected;
    }

    if (!window.isSecureContext && location.hostname !== 'localhost') {
      $('#insecureBanner').style.display = '';
    }

    const ble = new BleMicroPythonNUS({
      onLog: (t) => log(t),
      onStatus: (ok, name) => setConn(ok, name || ''),
      paceMs: 3,
    });

    function pyQuote(s) {
      return "'" + s.replace(/\\/g, "\\\\").replace(/'/g, "\\'") + "'";
    }

    async function connect() {
      try {
        const prefix = 'MEBLOCK-';
        log(`Scanning for '${prefix}*'...`);
        await ble.connect();   // prefix mặc định trong JS
      } catch (err) {
        log(`[CONNECT ERROR] ${err}`);
        setConn(false);
      }
    }

    async function disconnect() {
      try { await ble.disconnect(); }
      catch (e) { log(`[DISCONNECT ERR] ${e}`); }
    }

    async function runSelected() {
      const fi = $('#runFile');
      if (!fi.files || fi.files.length === 0) {
        log('Pick a .py file first.');
        return;
      }
      await ble.runFile(fi.files[0]);
    }

    async function stopRun() { await ble.stop(); }
    async function doReset() { await ble.reset(); }

    async function flashSelected() {
      const fi = $('#flashFile');
      if (!fi.files || fi.files.length === 0) {
        log('Pick a .py file first.');
        return;
      }
      const dst = ($('#dstName').value || 'main.py').trim();
      await ble.flashFile(fi.files[0], { dst, onProgress: p => {} });
    }

    // Đổi tên BLE qua BLE NUS
    async function setBleNameAndReset() {
      const suffix = $('#bleSuffix').value.trim();
      if (!suffix) {
        log('Nhập suffix mới trước (ví dụ: R1-01).');
        return;
      }
      const quoted = pyQuote(suffix);
      const script = `
import setting, machine
setting.set_device_suffix(${quoted})
machine.reset()
`;
      try {
        log(`Đổi tên BLE: MEBLOCK-${suffix} ...`);
        await ble.runCode(script, { label: 'set_ble_name' });
      } catch (err) {
        log(`[SET NAME ERROR] ${err}`);
      }
    }

    // bind
    $('#btnConnect').addEventListener('click', connect);
    $('#btnDisconnect').addEventListener('click', disconnect);
    $('#btnRunFile').addEventListener('click', runSelected);
    $('#btnStop').addEventListener('click', stopRun);
    $('#btnReset').addEventListener('click', doReset);
    $('#btnFlash').addEventListener('click', flashSelected);
    $('#btnSetBleName').addEventListener('click', setBleNameAndReset);

    setConn(false);
  </script>
</body>
</html>
